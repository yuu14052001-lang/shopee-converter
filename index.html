async function process() {
    const input = document.getElementById('inputUrl').value.trim();
    if (!input) return;
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('result-area').style.display = 'none';

    try {
        let target = "";

        // Nếu là link ngắn, bắt buộc phải qua GAS
        if (input.includes("s.shopee.vn") || input.includes("shope.ee")) {
            const res = await fetch(`${GAS_URL}?url=${encodeURIComponent(input)}`);
            const data = await res.json();
            
            // Nếu GAS không trả về longUrl, chúng ta dừng lại và báo lỗi
            if (data && data.longUrl && data.longUrl.includes("shopee.vn/product")) {
                target = data.longUrl;
            } else {
                alert("LỖI: Không thể bung link ngắn. Hãy kiểm tra lại quyền 'Anyone' trên Google Script!");
                document.getElementById('loading').style.display = 'none';
                return;
            }
        } else {
            target = input;
        }
        
        // Xử lý link dài đã bung
        const urlObj = new URL(target);
        const cleanUrl = urlObj.origin + urlObj.pathname;
        const final = `${cleanUrl}?utm_source=an_${MY_ID}&utm_medium=affiliates&utm_campaign=web_tool_v3`;
        
        document.getElementById('finalLink').innerText = final;
        document.getElementById('result-area').style.display = 'block';
    } catch (e) {
        alert("LỖI KẾT NỐI: Trình duyệt bị chặn hoặc link Google Script sai!");
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}
