async function handleConvert() {
    const input = document.getElementById('inputUrl').value.trim();
    if (!input) return alert("Vui lòng dán link!");

    document.getElementById('loading').style.display = 'block';
    document.getElementById('result').style.display = 'none';

    try {
        let longUrl = input;

        // Nếu là link ngắn, gọi GAS
        if (input.includes("s.shopee.vn") || input.includes("shope.ee")) {
            // Thêm tham số ngẫu nhiên để tránh trình duyệt dùng lại kết quả cũ (Cache)
            const response = await fetch(`${GAS_URL}?url=${encodeURIComponent(input)}&cache=${Math.random()}`, {
                method: 'GET'
            });
            
            const data = await response.json();
            if (data.longUrl) {
                longUrl = data.longUrl;
            } else {
                throw new Error("GAS không trả về link");
            }
        }

        // Làm sạch link (loại bỏ mọi thông tin cũ sau dấu ?)
        let cleanUrl = longUrl.split('?')[0];
        cleanUrl = cleanUrl.replace("m.shopee.vn", "shopee.vn");

        // Gắn ID của bạn
        const finalAff = `${cleanUrl}?utm_source=an_${MY_ID}&utm_medium=affiliates&utm_campaign=web_tool_fixed`;

        document.getElementById('finalLink').innerText = finalAff;
        document.getElementById('result').style.display = 'block';
    } catch (e) {
        console.error(e);
        alert("Lỗi: Trình duyệt vẫn chặn kết nối hoặc Google Script chưa được cập nhật đúng cách!");
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}
